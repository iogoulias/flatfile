<h2>If there's a different row for every presenter/chair, upload here:</h2>
  <label for="fname">Client:</label>
  <input type="text" id="fname" name="fname"><br><br>
<button onclick="importer.requestDataFromUser().then(async function(results) { 
importer.displayLoader();
var client=document.getElementById('fname').value;
if (client==null || client=='') {
client=12345;
}
client=client+'_'+(new Date()).toISOString();
    var data=(results.data);
	var speakers={};
	var sessions={};
	data=data.map(function(v){if(!v.hasOwnProperty('sessionid')){v['sessionid']=v['sessiontitle']};if(!v.hasOwnProperty('presentertitle') || v['presentertitle']==null ){v['presentertitle']=''}; v['email']=String(v['email']).toLowerCase(); if(!v.hasOwnProperty('email') || v['email']==null || v['email']=='' ){v['email']=(v['presentertitle']+' '+v['firstname']+' '+v['lastname']).trim()}; return v})
	for (var i=0;i<data.length;i++) {
	if (!speakers.hasOwnProperty(data[i]['email'])) {
	speakers[data[i]['email']]={'Name':(data[i]['presentertitle']+' '+data[i]['firstname']+' '+data[i]['lastname']).trim(),
	'ImportId':client,'Title':data[i]['presentertitle'],'First name':data[i]['firstname'],'Last name':data[i]['lastname'],'Email':data[i]['email'],'City':data[i]['city'],'Country':data[i]['country']
	}
	if (data[i]['role']=='Speaker') {
	speakers[data[i]['email']]['Speaking Sessions']=[data[i]['sessionid']]
	speakers[data[i]['email']]['Moderating Sessions']=[];
	} else {
	speakers[data[i]['email']]['Moderating Sessions']=[data[i]['sessionid']]
	speakers[data[i]['email']]['Speaking Sessions']=[];	
	}
	} else {
	
	if (data[i]['role']=='Speaker') {
	(speakers[data[i]['email']]['Speaking Sessions']).push(data[i]['sessionid']);
	} else {
	(speakers[data[i]['email']]['Moderating Sessions']).push(data[i]['sessionid'])
	}
	
	}
	
	if (!sessions.hasOwnProperty(data[i]['sessionid'])) {
	sessions[data[i]['sessionid']]={'Session Id':data[i]['sessionid'],'ImportId':client,'Name':data[i]['sessiontitle'],'Start time':data[i]['sessionfrom'],'End time':data[i]['sessionto'],'Date':data[i]['sessiondate'],'Session type':data[i]['sessiontype'],'Stage':data[i]['room']}
	
		if (data[i]['role']=='Speaker') {
		sessions[data[i]['sessionid']]['Speakers']=[data[i]['email']];
		sessions[data[i]['sessionid']]['Moderators']=[];
		} else {			
		sessions[data[i]['sessionid']]['Speakers']=[];
		sessions[data[i]['sessionid']]['Moderators']=[data[i]['email']];
		}
	
	} else {
	if (data[i]['role']=='Speaker') {
	(sessions[data[i]['sessionid']]['Speakers']).push(data[i]['email'])
	} else {
	(sessions[data[i]['sessionid']]['Moderators']).push(data[i]['email'])	
	}
	
	}
	
	
	}
	console.log(speakers)
	console.log(sessions)
	var sessions_arr=[];
	var speakers_arr=[];
	for (var key in speakers) {
	speakers_arr.push(speakers[key])
	}
	for (var key in sessions) {
	sessions_arr.push(sessions[key])
	}
	sessions=sessions_arr;
	speakers=speakers_arr;
    sessions=sessions.map(function(value){value['Speakers']=(value['Speakers']).join(','); return value});
	sessions=sessions.map(function(value){value['Moderators']=(value['Moderators']).join(','); return value});
	speakers=speakers.map(function(value){value['Speaking Sessions']=(value['Speaking Sessions']).join(','); return value});
	speakers=speakers.map(function(value){value['Moderating Sessions']=(value['Moderating Sessions']).join(','); return value});

var payload={'records':[]};
var payload2={'records':[]};
	for (var i=0;i<sessions.length;i++) {
payload.records.push({'fields':sessions[i]})
}
	for (var i=0;i<speakers.length;i++) {
payload2.records.push({'fields':speakers[i]})
}

await airtable(payload,'Sessions%20Import');
await wait(200);
await airtable(payload2,'Speakers%20Import')

async function airtable(payload,table) {

    var airtableresp = await fetch('https://api.airtable.com/v0/appTwnTbrb7NXDfci/'+table, {
    'method': 'POST',
    'headers': {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer '+'keyjBiRLhAGxVa5J9'
    },
    'body': JSON.stringify({records:payload.records.slice(0,10)})
  }).then(x=>x.json()).then(
  async function(data){
  console.log(data);
  payload.records=payload.records.slice(10)
  if (payload.records.length>0) {
  await wait(200)
  await airtable(payload,table)
  }
  })
  
  }
  
  
   function wait(ms) {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      console.log('Done waiting');
      resolve(ms)
    }, ms )
  })
}
	
	
	
    importer.displaySuccess('Thanks for uploading your data!')
})">Start Import</button>
<h2>Otherwise upload here:</h2>
  <label for="fname2">Client:</label>
  <input type="text" id="fname2" name="fname2"><br><br>
<button onclick="importer2.requestDataFromUser().then(async function(results) { 
importer2.displayLoader();
var client=document.getElementById('fname2').value;
if (client==null || client=='') {
client=12345;
}
client=client+'_'+(new Date()).toISOString();
    var data=(results.data);
	var speakers={};
	var sessions={};
	var addedchairs={};
	data=data.map(function(v){if(!v.hasOwnProperty('sessionid')){v['sessionid']=v['sessiontitle']}; if(!v.hasOwnProperty('presentertitle') || v['presentertitle']==null ){v['presentertitle']=''};v['email']=String(v['email']).toLowerCase(); if(!v.hasOwnProperty('email') || v['email']==null || v['email']=='' ){v['email']=(v['presentertitle']+' '+v['firstname']+' '+v['lastname']).trim()};v['role']='Speaker'; return v})
	var data2=[];
    for (var i=0;i<data.length;i++) {
		for (var k=1;k<6;k++) {
			if ((!addedchairs.hasOwnProperty(data[i]['sessionid']) || (addedchairs.hasOwnProperty(data[i]['sessionid']) && !(addedchairs[data[i]['sessionid']]).hasOwnProperty(data[i]['chair'+k+'_email']) )) && data[i]['chair'+k+'_email']!='' && data[i]['chair'+k+'_email']!=null) {
		var tempobj={ ...data[i]};
		tempobj['role']='Chair';
		tempobj['firstname']=data[i]['chair'+k+'_firstname'];
		tempobj['lastname']=data[i]['chair'+k+'_lastname'];
		tempobj['presentertitle']='';
		tempobj['city']='';
		tempobj['country']='';
		tempobj['email']=String(data[i]['chair'+k+'_email']).toLowerCase();
		data2.push({ ...tempobj })
		console.log(tempobj)
		console.log('k: '+k);
		console.log('chair_k_email: '+String(data[i]['chair'+k+'_email']).toLowerCase())
		console.log('tempobj email: '+tempobj['email'])
		console.log('data2 last email: '+data2[data2.length-1]['email'])
		console.log(data2.length)
		if (!addedchairs.hasOwnProperty(data[i]['sessionid'])) { 
		addedchairs[data[i]['sessionid']]={};
		}
		addedchairs[data[i]['sessionid']][data[i]['chair'+k+'_email']]=1;
			}
		}
	}

	data=data.concat(data2);
	var includekeys={'presentertitle':1,'firstname':1,'lastname':1,'email':1,'city':1,'country':1,'sessiontitle':1,'sessiondate':1,'sessionfrom':1,'sessionto':1,'sessiontype':1,'room':1,'role':1,'sessionid':1}
    data=data.map(function(v){
		var newv={};
		for (var key in v) { if (includekeys.hasOwnProperty(key)) { newv[key]=v[key]}}
		return newv;
	})
    for (var i=0;i<data.length;i++) {
	if (!speakers.hasOwnProperty(data[i]['email'])) {
	speakers[data[i]['email']]={'Title':data[i]['presentertitle'],'Name':(data[i]['presentertitle']+' '+data[i]['firstname']+' '+data[i]['lastname']).trim(),
	'ImportId':client,'First name':data[i]['firstname'],'Last name':data[i]['lastname'],'Email':data[i]['email'],'City':data[i]['city'],'Country':data[i]['country']
	}
	
	if (data[i]['role']=='Speaker') {
	speakers[data[i]['email']]['Speaking Sessions']=[data[i]['sessionid']]
	speakers[data[i]['email']]['Moderating Sessions']=[];
	} else {
	speakers[data[i]['email']]['Moderating Sessions']=[data[i]['sessionid']]
	speakers[data[i]['email']]['Speaking Sessions']=[];	
	}
	
	} else {
	if (data[i]['role']=='Speaker') {
	(speakers[data[i]['email']]['Speaking Sessions']).push(data[i]['sessionid']);
	} else {
	(speakers[data[i]['email']]['Moderating Sessions']).push(data[i]['sessionid'])
	}
	}
	
	if (!sessions.hasOwnProperty(data[i]['sessionid'])) {
	sessions[data[i]['sessionid']]={'Session Id':data[i]['sessionid'],'ImportId':client,'Name':data[i]['sessiontitle'],'Start time':data[i]['sessionfrom'],'End time':data[i]['sessionto'],'Date':data[i]['sessiondate'],'Session type':data[i]['sessiontype'],'Stage':data[i]['room']}
	
		if (data[i]['role']=='Speaker') {
		sessions[data[i]['sessionid']]['Speakers']=[data[i]['email']];
		sessions[data[i]['sessionid']]['Moderators']=[];
		} else {			
		sessions[data[i]['sessionid']]['Speakers']=[];
		sessions[data[i]['sessionid']]['Moderators']=[data[i]['email']];
		}
	
	} else {
	if (data[i]['role']=='Speaker') {
	(sessions[data[i]['sessionid']]['Speakers']).push(data[i]['email'])
	} else {
	(sessions[data[i]['sessionid']]['Moderators']).push(data[i]['email'])	
	}
	
	}
	
	
	}
	console.log(speakers)
	console.log(sessions)
	var sessions_arr=[];
	var speakers_arr=[];
	for (var key in speakers) {
	speakers_arr.push(speakers[key])
	}
	for (var key in sessions) {
	sessions_arr.push(sessions[key])
	}
	sessions=sessions_arr;
	speakers=speakers_arr;
    sessions=sessions.map(function(value){value['Speakers']=(value['Speakers']).join(','); return value});
	sessions=sessions.map(function(value){value['Moderators']=(value['Moderators']).join(','); return value});
	speakers=speakers.map(function(value){value['Speaking Sessions']=(value['Speaking Sessions']).join(','); return value});
	speakers=speakers.map(function(value){value['Moderating Sessions']=(value['Moderating Sessions']).join(','); return value});

var payload={'records':[]};
var payload2={'records':[]};
	for (var i=0;i<sessions.length;i++) {
payload.records.push({'fields':sessions[i]})
}
	for (var i=0;i<speakers.length;i++) {
payload2.records.push({'fields':speakers[i]})
}

await airtable(payload,'Sessions%20Import');
await wait(200);
await airtable(payload2,'Speakers%20Import')

async function airtable(payload,table) {

    var airtableresp = await fetch('https://api.airtable.com/v0/appTwnTbrb7NXDfci/'+table, {
    'method': 'POST',
    'headers': {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer '+'keyjBiRLhAGxVa5J9'
    },
    'body': JSON.stringify({records:payload.records.slice(0,10)})
  }).then(x=>x.json()).then(
  async function(data){
  console.log(data);
  payload.records=payload.records.slice(10)
  if (payload.records.length>0) {
  await wait(200)
  await airtable(payload,table)
  }
  })
  
  }
  
  
   function wait(ms) {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      console.log('Done waiting');
      resolve(ms)
    }, ms )
  })
}
	
	
	
    importer2.displaySuccess('Thanks for uploading your data!')
})">Start Import</button>
<script src="https://unpkg.com/@flatfile/adapter/build/dist/index.min.js"></script>

<script>
const importer = new FlatfileImporter("bd4ed93e-83cb-4d62-a5b7-4a18ebdb9ce2", {
  type: "imports",
  fields: [
      {key: "firstname", label: "First name"},
	  {key: "lastname", label: "Name"},
	  {key: "presentertitle", label: "Presenter Title"},
	  {key: "email", label: "Email", validators:[{validate:'regex_matches',regex:"^\\w+([-+.']\\w+)*@\\w+([-.]\\w+)*\\.\\w+([-.]\\w+)*$",error: 'Invalid Email Format or Empty Field'}]},
	  {key: "city", label: "City"},
	  {key: "country", label: "Country"},
	  {key: "sessiontitle", label: "SessionTitle"},
	  {key: "sessiondate", label: "SessionDate",validators:[{validate:'regex_matches',regex:"^(0[1-9]|[12][0-9]|3[01])[/](0[1-9]|1[012])[/](19|20)[0-9][0-9]$",error: 'Invalid Date Format or Empty Field'}]},
	  {key: "sessionfrom", label: "SessionFrom",validators:[{validate:'regex_matches',regex:"^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$",error: 'Invalid Time Format or Empty Field'}]},
	  {key: "sessionto", label: "SessionTo", validators:[{validate:'regex_matches',regex:"^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$",error: 'Invalid Time Format or Empty Field'}]},
	  {key: "sessiontype", label: "SessionType"},
	  {key: "room", label: "Room"},
	  {key: "role", label: "Function", validators:[{validate:'regex_matches',regex:"^(Chair)|(Speaker)$",error: 'Invalid Role Format or Empty Field'}]},
	  {key: "sessionid", label: "SessionID"},
    ],
  managed: true,
  devMode:true
});
var client=document.getElementById('fname').value;
if (client==null || client=="") {
client=12345;
}
importer.setCustomer({userId: client});

importer.registerRecordHook(record => {
  let out = {}
  if (record.sessiondate && record.sessiondate!="" && record.sessiondate!=null && (record.sessiondate).match("(0[1-9]|[12][0-9]|3[01])[/](0[1-9]|1[012])[/](19|20)[0-9][0-9]")==null ) {
    out.sessiondate = {
      value: new Date(record.sessiondate).toLocaleDateString('fr'),
      info: [
        {
          message: 'Fixed Date Format',
          level: 'info'
        }
      ]
    }
  }
  if ( record.sessionfrom!=null && (record.sessionfrom).match(/\d\d:\d\d/gi)!=null && record.sessionfrom!=(record.sessionfrom).match(/\d\d:\d\d/gi)[0] ) {
  out.sessionfrom = {
      value: (record.sessionfrom).match(/\d\d:\d\d/gi)[0],
      info: [
        {
          message: 'Fixed Time Format',
          level: 'info'
        }
      ]  
  }
  }
  if ( record.sessionto!=null && (record.sessionto).match(/\d\d:\d\d/gi)!=null && record.sessionto!=(record.sessionto).match(/\d\d:\d\d/gi)[0] ) {
  out.sessionto = {
      value: (record.sessionto).match(/\d\d:\d\d/gi)[0],
      info: [
        {
          message: 'Fixed Time Format',
          level: 'info'
        }
      ]  
  }
  }

  if (record.role!=null && record.role!="") {
  if (((record.role).toLowerCase()).indexOf("speaker")>-1) {
  out.role = {
      value: "Speaker",
      info: [
        {
          message: 'Fixed Role Format',
          level: 'info'
        }
      ]  
  }  
  } else {
  out.role = {
      value: "Chair",
      info: [
        {
          message: 'Fixed Role Format',
          level: 'info'
        }
      ]  
  }   
  }
  } else {
  out.role = {
      value: "Speaker",
      info: [
        {
          message: 'Fixed Role Format',
          level: 'info'
        }
      ]  
  }    
  }
  
  return out
})

const importer2 = new FlatfileImporter("bd4ed93e-83cb-4d62-a5b7-4a18ebdb9ce2", {
  type: "imports",
  fields: [
      {key: "firstname", label: "Presenter First Name"},
	  {key: "lastname", label: "Presenter Surname"},
	  {key: "presentertitle", label: "Presenter Title"},
	  {key: "email", label: "Presentation Author Email", validators:[{validate:'regex_matches',regex:"^\\w+([-+.']\\w+)*@\\w+([-.]\\w+)*\\.\\w+([-.]\\w+)*$",error: 'Invalid Email Format or Empty Field'}]},
	  {key: "city", label: "Presenter City"},
	  {key: "country", label: "Presentation Authors Country"},
	  {key: "chair1_firstname", label: "Chair1 Firstname"},
	  {key: "chair1_lastname", label: "Chair1 Surname"},
	  {key: "chair1_email", label: "Chair1 Email", validators:[{validate:'regex_matches',regex:"^\\w+([-+.']\\w+)*@\\w+([-.]\\w+)*\\.\\w+([-.]\\w+)*$",error: 'Invalid Email Format or Empty Field'}]},
	  {key: "chair2_firstname", label: "chair2 Firstname"},
	  {key: "chair2_lastname", label: "chair2 Surname"},
	  {key: "chair2_email", label: "chair2 Email", validators:[{validate:'regex_matches',regex:"^\\w+([-+.']\\w+)*@\\w+([-.]\\w+)*\\.\\w+([-.]\\w+)*$",error: 'Invalid Email Format or Empty Field'}]},
	  {key: "chair3_firstname", label: "chair3 Firstname"},
	  {key: "chair3_lastname", label: "chair3 Surname"},
	  {key: "chair3_email", label: "chair3 Email", validators:[{validate:'regex_matches',regex:"^\\w+([-+.']\\w+)*@\\w+([-.]\\w+)*\\.\\w+([-.]\\w+)*$",error: 'Invalid Email Format or Empty Field'}]},
	  {key: "chair4_firstname", label: "chair4 Firstname"},
	  {key: "chair4_lastname", label: "chair4 Surname"},
	  {key: "chair4_email", label: "chair4 Email", validators:[{validate:'regex_matches',regex:"^\\w+([-+.']\\w+)*@\\w+([-.]\\w+)*\\.\\w+([-.]\\w+)*$",error: 'Invalid Email Format or Empty Field'}]},
	  {key: "chair5_firstname", label: "chair5 Firstname"},
	  {key: "chair5_lastname", label: "chair5 Surname"},
	  {key: "chair5_email", label: "chair5 Email", validators:[{validate:'regex_matches',regex:"^\\w+([-+.']\\w+)*@\\w+([-.]\\w+)*\\.\\w+([-.]\\w+)*$",error: 'Invalid Email Format or Empty Field'}]},	  	  
	  {key: "sessiontitle", label: "Session Title"},
	  {key: "sessiondate", label: "Session Date",validators:[{validate:'regex_matches',regex:"^(0[1-9]|[12][0-9]|3[01])[/](0[1-9]|1[012])[/](19|20)[0-9][0-9]$",error: 'Invalid Date Format or Empty Field'}]},
	  {key: "sessionfrom", label: "Session Start",validators:[{validate:'regex_matches',regex:"^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$",error: 'Invalid Time Format or Empty Field'}]},
	  {key: "sessionto", label: "Session End", validators:[{validate:'regex_matches',regex:"^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$",error: 'Invalid Time Format or Empty Field'}]},
	  {key: "sessiontype", label: "Session Type"},
	  {key: "room", label: "Room Name"},
	  {key: "sessionid", label: "Manage Session Id"},
    ],
  managed: true,
  devMode:true
});
var client=document.getElementById('fname2').value;
if (client==null || client=="") {
client=12345;
}
importer2.setCustomer({userId: client});

importer2.registerRecordHook(record => {
  let out = {}
  if (record.sessiondate && record.sessiondate!="" && record.sessiondate!=null && (record.sessiondate).match("(0[1-9]|[12][0-9]|3[01])[/](0[1-9]|1[012])[/](19|20)[0-9][0-9]")==null ) {
    out.sessiondate = {
      value: new Date(record.sessiondate).toLocaleDateString('fr'),
      info: [
        {
          message: 'Fixed Date Format',
          level: 'info'
        }
      ]
    }
  }
  if ( record.sessionfrom!=null && (record.sessionfrom).match(/\d\d:\d\d/gi)!=null && record.sessionfrom!=(record.sessionfrom).match(/\d\d:\d\d/gi)[0] ) {
  out.sessionfrom = {
      value: (record.sessionfrom).match(/\d\d:\d\d/gi)[0],
      info: [
        {
          message: 'Fixed Time Format',
          level: 'info'
        }
      ]  
  }
  }
  if ( record.sessionto!=null && (record.sessionto).match(/\d\d:\d\d/gi)!=null && record.sessionto!=(record.sessionto).match(/\d\d:\d\d/gi)[0] ) {
  out.sessionto = {
      value: (record.sessionto).match(/\d\d:\d\d/gi)[0],
      info: [
        {
          message: 'Fixed Time Format',
          level: 'info'
        }
      ]  
  }
  }
  
  return out
})

</script>
